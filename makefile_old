# Compiler
CXX = g++
CC = gcc

DEPFLAGS = -MP -MD
OPT = -O0

# Compiler flags
CXXFLAGS = -std=c++17 -Icore/include -Iexamples/include $(DEPFLAGS) $(OPT)
CFLAGS = -Icore/include -Iexamples/include $(DEPFLAGS) $(OPT)

# Directories
CORE_SRC_DIR = core/src
CORE_INC_DIR = core/include
TEST_DIR = tests
EXAMPLE_DIR = examples/src
BUILD_DIR = build

# Create build directory if it does not exist
$(shell mkdir -p $(BUILD_DIR))

# Source files
CXX_SRC_FILES_CORE = $(wildcard $(CORE_SRC_DIR)/*.cpp)
C_SRC_FILES_CORE = $(wildcard $(CORE_SRC_DIR)/*.c)

CXX_SRC_FILES_EXAMPLE = $(wildcard $(EXAMPLE_DIR)/*.cpp)
C_SRC_FILES_EXAMPLE = $(wildcard $(EXAMPLE_DIR)/*.c)

CXX_SRC_FILES_TEST = $(wildcard $(TEST_DIR)/*.cpp)
C_SRC_FILES_TEST = $(wildcard $(TEST_DIR)/*.c)

# Object files
CXX_OBJ_FILES_CORE = $(patsubst %.cpp, $(BUILD_DIR)/%.o, $(notdir $(CXX_SRC_FILES_CORE)))
C_OBJ_FILES_CORE = $(patsubst %.c, $(BUILD_DIR)/%.o, $(notdir $(C_SRC_FILES_CORE)))

CXX_OBJ_FILES_EXAMPLE = $(patsubst %.cpp, $(BUILD_DIR)/%.o, $(notdir $(CXX_SRC_FILES_EXAMPLE)))
C_OBJ_FILES_EXAMPLE = $(patsubst %.c, $(BUILD_DIR)/%.o, $(notdir $(C_SRC_FILES_EXAMPLE)))

CXX_OBJ_FILES_TEST = $(patsubst %.cpp, $(BUILD_DIR)/%.o, $(notdir $(CXX_SRC_FILES_TEST)))
C_OBJ_FILES_TEST = $(patsubst %.c, $(BUILD_DIR)/%.o, $(notdir $(C_SRC_FILES_TEST)))

CXX_OBJ_FILES = $(CXX_OBJ_FILES_CORE) $(CXX_OBJ_FILES_EXAMPLE) $(CXX_OBJ_FILES_TEST)
C_OBJ_FILES = $(C_OBJ_FILES_CORE) $(C_OBJ_FILES_EXAMPLE) $(C_OBJ_FILES_TEST)

# Dependency files
DEP_FILES = $(CXX_OBJ_FILES:.o=.d) $(C_OBJ_FILES:.o=.d)

# Output binaries
CORE_TARGET = $(BUILD_DIR)/core
TEST_TARGET = $(BUILD_DIR)/test
EXAMPLE_TARGET = $(BUILD_DIR)/example

# Include dependency files
-include $(DEP_FILES)

test:
	@echo $(DEP_FILES)


# Default target
all: $(CORE_TARGET) $(TEST_TARGET) $(EXAMPLE_TARGET)

# Linking the core library (C++)
$(CORE_TARGET): $(CXX_OBJ_FILES_CORE) $(C_OBJ_FILES_CORE)
	$(CXX) -o $@ $^

# Linking the test executable (C++ or C)
$(TEST_TARGET): $(CXX_OBJ_FILES_CORE) $(C_OBJ_FILES_CORE) $(CXX_OBJ_FILES_TEST) $(C_OBJ_FILES_TEST)
	$(CXX) -o $@ $^ -I. -I$(CORE_INC_DIR)

# Linking the example executable (C or C++)
$(EXAMPLE_TARGET): $(CXX_OBJ_FILES_CORE) $(C_OBJ_FILES_CORE) $(CXX_OBJ_FILES_EXAMPLE) $(C_OBJ_FILES_EXAMPLE)
	$(CXX) -o $@ $^ -I. -I$(CORE_INC_DIR)

# Compile C++ source files
$(BUILD_DIR)/%.o: $(CORE_SRC_DIR)/%.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(EXAMPLE_DIR)/%.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(TEST_DIR)/%.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Compile C source files
$(BUILD_DIR)/%.o: $(CORE_SRC_DIR)/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(EXAMPLE_DIR)/%.c
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(TEST_DIR)/%.c
	$(CC) $(CFLAGS) -c $< -o $@

# Run the example program
run_example: $(EXAMPLE_TARGET)
	./$(EXAMPLE_TARGET)

# Run the tests
run_test: $(TEST_TARGET)
	./$(TEST_TARGET)

# Clean target
clean:
	rm -rf $(BUILD_DIR)

# Separate build targets
build_core: $(CORE_TARGET)
	@echo "Core library built successfully."

build_tests: $(TEST_TARGET)
	@echo "Test program built successfully."

build_example: $(EXAMPLE_TARGET)
	@echo "Example program built successfully."

.PHONY: all clean run_example run_test build_core build_tests build_example
